name: Validate

on:
  pull_request:
    branches: [main]
    paths:
      - 'templates.yaml'
      - 'templates.schema.yaml'
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/validate.yml'

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install check-jsonschema pyyaml mkdocs mkdocs-material pymdown-extensions

      - name: Validate templates.yaml schema
        run: check-jsonschema --schemafile templates.schema.yaml templates.yaml

      - name: Validate unique template IDs
        run: |
          python -c "
          import yaml
          with open('templates.yaml') as f:
              config = yaml.safe_load(f)
          ids = [t['id'] for t in config.get('templates', [])]
          duplicates = [id for id in ids if ids.count(id) > 1]
          if duplicates:
              print(f'Duplicate template IDs found: {set(duplicates)}')
              exit(1)
          print(f'All {len(ids)} template IDs are unique')
          "

      - name: Build MkDocs (strict)
        run: mkdocs build --strict
